SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: >
    Runs $group queries which are designed to require spilling to disk.
Keywords:
    - Loader
    - CrudActor
    - QuiesceActor
    - insert
    - aggregate
    - group
    - spill

GlobalDefaults:
  Database: &Database test
  Collection: &Collection Collection0
  DocumentCount: &DocumentCount 2_000_000
  FirstFieldUniqueValCount: &FirstFieldUniqueValCount 20
  RandomStrLength: &RandomStrLength 60
  MaxPhases: &MaxPhases 3

Actors:
# Phase 0: Insert documents into the collection.
- Name: InsertData
  Type: Loader
  Threads: 4
  Phases:
    OnlyActiveInPhases:
      Active: [0]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Database: *Database
        MultipleThreadsPerCollection: true
        CollectionCount: 1
        DocumentCount: *DocumentCount
        BatchSize: 1000
        Document:
          first_field: {^RandomInt: {min: 1, max: *FirstFieldUniqueValCount}}
          second_field: {^RandomString: {length: *RandomStrLength, alphabet: "0123456789"}}

- Name: Quiesce
  Type: QuiesceActor
  Threads: 1
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [1]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Threads: 1

- Name: MatchInWithRegexes
  Type: CrudActor
  Database: *Database
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [2]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Collection: *Collection
        Operations:
        - OperationName: aggregate
          # TODO: This is bogus. Need to fix it.
          OperationCommand:
            Pipeline: [{$match: {f: 1}}, {$group: {_id: "$a"}}, {}]
